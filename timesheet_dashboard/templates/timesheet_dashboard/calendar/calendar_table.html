{% extends 'edc_base/base.html' %}
{% load timesheet_dashboard_extras %}
{% load static %}
{% load edc_base_extras edc_admin_modify %}
{% load i18n admin_urls %}

{% block title %}Timesheet Calendar{% endblock %}
{% block extra-css %}
  <link type="text/css" rel="stylesheet" href="{% static 'timesheet_dashboard/css/calendar_table.css' %}">
{% endblock %}

{% block main %}
<div class="row g-3">
  <!-- Main column -->
  <div class="col-12 col-lg-9">
  	{# Entry type legend #}

	<div class="legend justify-content-center">
	  {% for item in entry_types %}
	    <span class="legend-chip legend-{{ item.0|lower }}" title="{{ item.1 }}">
	      <span class="legend-code">{{ item.0 }}</span>
	      <span class="legend-label">{{ item.1 }}</span>
	    </span>
	  {% endfor %}
	</div>

    <!-- Toolbar -->
    <div class="md-card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between calendar-toolbar">
        <div class="d-flex align-items-center gap-2">
          <a {% if p_role %}
          		href="{% url timesheet_listboard_url employee_id %}?p_role={{ p_role }}"
          	 {% else %}
          	 	href="{% url timesheet_listboard_url employee_id %}"
          	 {% endif %}
          	class="btn btn-outline-info btn-sm">
          		<i class="bi bi-arrow-left"></i> Back to list
          </a>
          <h1 class="h5 mb-0">{{ month_name }} {{ year }}</h1>
        </div>
        
        {# Month navigation #}
        {% if is_reviewer %}
        	<div class="view-only-badge"
        		 data-bs-toggle="tooltip"
		         data-bs-placement="top"
		         title="Youâ€™re reviewing another employee. Edits are disabled.">
		      Read-only / Review mode
		    </div>
        {% else %}
	        <div class="nav-bar d-flex flex-wrap align-items-end gap-2">
	        	
	        	<a class="btn btn-sm btn-outline-primary" href="{{ prev_url }}" title="Previous month">
	        		<i class="bi bi-chevron-left"></i>
	        	</a>
	        
		        <form method="get" class="d-flex flex-wrap align-items-end gap-2">
		          <div>
		            <label class="form-label small mb-1">Jump to</label>
		            <input  type="month"
		            		name="ym"
		            		value="{{ year }}-{{ month|stringformat:'02d' }}"
		            		onchange="this.form.submit()"
		            		class="form-control form-control-sm" />
		          </div>
		        </form>
		        
		        <a class="btn btn-sm btn-outline-primary" href="{{ next_url }}" title="Next month">
		        	<i class="bi bi-chevron-right"></i>
		        </a>
		     </div>
		  {% endif %}
      </div>
    </div>

{% if monthly_entry %}
    <!-- Calendar header (Mon - Sun) -->
  
  	<form method="post" action="{{ self_url }}" novalidate>
  		{% csrf_token %}
  		{{ formset.non_form_errors }}
  		{{ formset.management_form }}
  		{{ form.id }} {# harmless even if form has no fields #}

      <div class="calendar-grid">

	    {# Header: Mon..Sun #}
	    {% for h in weekday_headers %}
	    	<div class="cal-head text-center">{{ h }}</div>
	    {% endfor %}

		{# Weeks #}
		{% for week in calendar_rows %}
			{% for cell in week %}
				{% if cell.date %}
	       		<div class="cal-day {% if day.is_today %}is-today{% endif %} {% if day.is_outside %}is-outside{% endif %}">
	              <div class="cal-date">{{ cell.date|date:'j'}}</div>
	              {% with f=cell.form %}
	              	{{ f.id }}
	              	<div class="day-form">
		              	<!-- Hiddent input fields for day and row -->
		              	<input 	type='hidden'
		                   		name='{{ f.day.html_name }}'
		                        value='{{ f.instance.day|date:"Y-m-d"}}' />
		                <input 	type='hidden'
		                   		name='{{ f.row.html_name }}'
		                        value='{{ f.row.value }}' />
		                <div class="mb-1">
		                	{% with errs=f.duration.errors %}
		                  	<input type="number"
		                  		   class="form-control form-control-sm {% if errs %} is-error {% endif %}"
		                  		   data-bs-toggle="tooltip"
		                  		   data-bs-placement="top"
		                  		   title="{% if errs %}{{errs|join:' & '}}{% endif %}"
		                  		   name="{{ f.duration.html_name }}"
		                  		   min="0" step="1" max="24"
		                  		   value="{{ f.duration.value|default_if_none:'' }}"
		                  		   {% if readonly %}
		                  		 		readonly
		                  		   {% endif %}>
		                  	{% endwith %}
		                  		
		               	</div>
		               	<div class="mb-1">
		               		{% with errs=f.entry_type.errors %}
		                  	<select class="form-select form-select-sm {% if errs %} is-error {% endif %}"
		                  			name="{{ f.entry_type.html_name }}"
		                  			data-bs-toggle="tooltip"
		                  		   	data-bs-placement="bottom"
		                  		   	title="{% if errs %}{{errs|join:' & '}}{% endif %}"
		                  			{% if readonly %}
		                  		 		disabled
		                  		 	{% endif %}>
		                  		 	{% if f.instance.day|is_holiday %}
		                  		 		<option value="H" selected>H</option>
		                  		 	{% elif f.instance.day|is_weekend %}
		                  		 		<option value="WE" selected>WE</option>
		                  		 	{% else %}
			                  		 	{% for val, label in f.entry_type.field.choices %}
			                  		 		<option value="{{ val }}" {% if f.entry_type.value == val %}selected{% endif %}>{{ val }}</option>
			                  		 	{% endfor %}
			                  		{% endif %}
		                  	</select>
		                  	{% endwith %}
		                </div>
		             </div>
		           {% endwith %}
	            </div>
	            {% else %}
	            	{# Outside-month padding cell #}
              		<div class="cal-day bg-light {% if day.is_today %}is-today{% endif %} {% if day.is_outside %}is-outside{% endif %}"></div>
	            {% endif %}    
	        {% endfor %}
	    {% endfor %}
      </div>
 
 	  <!-- Start submit buttons -->
      <div class="mt-2 d-flex justify-content-between">
      	<div class="d-flex gap-2 ms-auto">
	        {% if allow_edit %}
	        	{% if timesheet_status|lower == 'draft' %}
	        		<button type="button" id="autofill8" class="btn btn-primary">
	        			<i class="bi bi-input-cursor-text"></i> Autofill
	        		</button>
	        	{% endif %}
	        	<button type="submit" name="save" value="1" class="btn btn-warning" id="save-record">
                   <i class="bi bi-floppy"></i> Save Draft
               	</button>
               	<button type="submit" name="submit" value="1" class="btn btn-success"
               			id="save-submit-record">
                   <i class="bi bi-send-plus"></i> Save and Submit
               	</button>
            {% endif %}
	    </div>
      </div>
    </form>
    <form method="post" action="{{ self_url }}" class="review-buttons" id="reviewForm">
    	{% csrf_token %}
    	<div class="mt-2 d-flex justify-content-between">
	    	<div class="d-flex gap-2 ms-auto">
	    		{% if allow_sv_review %}
		            <button type="submit" name="review_action" value="reject" class="btn btn-danger">
		                <i class="bi bi-x-octagon-fill"></i> Reject
		            </button>
	
		            <button type="submit" name="review_action" value="approve" class="btn btn-success">
		                <i class="bi bi-hand-thumbs-up-fill"></i> Approve
		            </button>
		        {% elif allow_hr_review %}
					<button type="submit" name="review_action" value="reject" class="btn btn-danger">
		                <i class="bi bi-x-octagon-fill"></i> Reject
		            </button>
	
		            <button type="submit"  name="review_action" value="verify" class="btn btn-success">
		                <i class="bi bi-shield-fill-check"></i> Verify
		            </button>
		        {% endif %}
	    	</div>
	    </div>
    </form>
  
   	{% if not allow_edit and not allow_hr_review and not allow_sv_review %}
   	<div class="mt-2 d-flex justify-content-between">
   	 	<div class="d-flex gap-2 ms-auto">
        	{% if timesheet_status|lower == 'rejected' %}
                  <a type="button" class="btn btn-danger opacity-75" disabled>
                      {{ timesheet_status }}
                  </a>
             {% else %}
                  <a type="button" class="btn btn-success opacity-75" disabled>
                      {{ timesheet_status }}
                  </a>
             {% endif %}
   		</div>
   	</div>
   	{% endif %}
{% else %}
	{# Not started yet: show a read-only calendar preview #}
    <div class="preview">
    	<p>This month has not been started yet.</p>
    	<div class="calendar-grid">
    		{% for h in weekday_headers %}
	    		<div class="cal-head text-center">{{ h }}</div>
	    	{% endfor %}
	    	{% for week in calendar_rows %}
	    		{% for cell in week %}
	    			{% if cell.date %}
	    			<div class="day-form">
    					<div class="cal-date">{{ cell.date|date:'j'}}</div>
    					<p class="cal-day text-secondary text-center fs-6">- not started -</p>
    				</div>
    				{% else %}
    					<div class="cal-day bg-light"></div>
    				{% endif %}
    			{% endfor %}
    		{% endfor %}
    	</div>
 
 		{% if can_create_for_month %}
 			<form method="post" class="start-form">
 				{% csrf_token %}
 				{# Minimal POST that triggers creation; the view will make placeholders #}
 				<div class="mt-2 d-flex justify-content-between">
      				<div class="d-flex gap-2 ms-auto">
		 			 	<button type="submit" name="start" value="1" class="btn btn-info opacity-75" id="auto-fill">
		                	<i class="bi bi-plus-circle"></i> Start timesheet
		               	</button>
		            </div>
		        </div>
 			</form>
 		{% else %}
 			<p class="muted">Starting future months is disabled.</p>
 		{% endif %}
    </div>
 {% endif %}
  	<div class="d-flex justify-content-between align-items-center mt-2 calendar-legend">
      	<div class="d-flex gap-2 align-items-center small">
        	<span class="badge text-bg-primary"><i class="bi bi-clock-history me-1"></i>Hours</span>
        	<span class="badge text-bg-warning"><i class="bi bi-lightning-charge me-1"></i>Overtime</span>
        	<span class="badge text-bg-success"><i class="bi bi-sun me-1"></i>Leave</span>
      	</div>
      	<div class="small text-secondary"><b>NOTE:</b> Complete all entries before <em>*Save and Submit*</em>. Use <em>*Save*</em> to keep progress.</div>
    </div>
 </div>
 
 <!-- Begin SidePanel -->
 <div class="col-12 col-lg-3">
    <div class="md-card">
      <div class="card-body">
      	<h5 class="card-title p-3 bg-info bg-opacity-10 border border-info rounded-start rounded-end">Employee {{ employee_id }}</h5>
        <hr>
        {% demographics employee_id %}
        <hr>
        <h6 class="mb-2">Monthly Stats</h6>
        <div class="d-flex flex-column gap-2 small">
  			{% if leave_balance %}
          	<div class="d-flex justify-content-between">
          		<i class="bi bi-calendar2-check text-success"></i>
          		<span>Annual Leave Taken:</span><strong>{{ leave_taken|default:'0' }}</strong>
          	</div>
          	<div class="d-flex justify-content-between">
          		<i class="bi bi-calendar2-plus text-primary"></i>
          		<span>Annual Leave Balance:</span><strong>{{ leave_balance|default:'0' }}</strong>
          	</div>
			{% endif %}
          	<div class="d-flex justify-content-between">
          		<i class="bi bi-hourglass-split text-warning"></i>
          		<span>Monthly Overtime:</span><strong>{{ overtime_worked|default:'0' }}</strong>
          	</div>
        </div>
        <hr>
        <h6 class="mb-2">Timesheet Status</h6>
        <div class="d-flex flex-column gap-2 small">   	
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-info-circle text-info"></i>
       			<span>Status:</span>
       			<span class="badge text-bg-{{ timesheet_status_badge|default:'primary' }}">
       				{{ timesheet_status|default:'draft' }}
       			</span>
       		</div>
       		{% if submitted_datetime %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-calendar2-event text-primary"></i>
       			<span>Submitted:</span><span class="small">{{ submitted_datetime|date:"SHORT_DATETIME_FORMAT" }}</span>
       		</div>
       		{% endif %}
       		{% if rejected_by %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-calendar2-x text-danger"></i>
       			<span>Rejected:</span>{{ rejected_by }}
       		</div>
       		{% endif %}
       		{% if approved_by %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-calendar2-check text-success"></i>
       			<span>Approved By:</span>{{ approved_by }}
       		</div>
       		{% endif %}
       		{% if verified_by %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-person-check text-success"></i>
       			<span>Verified By:</span>{{ verified_by }}
       		</div>
       		
       		{% endif %}
        </div>
        <hr>
        <div class="d-flex flex-column gap-2">
        	<h6 class="mb-2">Comments</h6>
        
      		<textarea 	form="reviewForm"
	      				class="form-control comment-section"
	      	    		name="review_comment"
	                    rows="6"
	                    {% if allow_hr_review or allow_sv_review %}
	                    {% else %}
	                    	disabled
	                    {% endif %}>{% if comment %}{{ comment }}{% endif %}</textarea>
         </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra-scripts %}
	<script>
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(
            		document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
        
        (function() {
        	  const btn = document.getElementById('autofill8');
        	  if (!btn) return;

        	  btn.addEventListener('click', function () {
        	    // Scope to the nearest form so we don't grab other inputs on the page
        	    const form = this.closest('form');
        	    if (!form) return;

        	    // Find every entry_type select in the formset
        	    const typeSelects = form.querySelectorAll('select[name$="-entry_type"]')

        	    // Warn if we're going to overwrite something
        	    let willOverwrite = false;
        	    typeSelects.forEach(sel => {
        	    	if (sel.value === 'RH') {
        	    		const durationName = sel.name.replace(/entry_type$/, 'duration');
        	    		const durationInput = form.querySelector(`input[name="${durationName}"]`);
        	    		if (durationInput && durationInput.value && durationInput.value != 8) {
        	    			willOverwrite = true;
        	    		}
        	    	}
        	    });
        	    
        	    if (willOverwrite && !confirm("This will set 8 hours on Regular Hours (RH) days without hours set. Continue?")) {
        	      return;
        	    }

        	    let changed = 0;
        	    typeSelects.forEach(sel => {
        	        if (sel.value === 'RH') {
        	          const durationName = sel.name.replace(/entry_type$/, 'duration');
        	          const durationInput = form.querySelector(`input[name="${durationName}"]`);
						
        	          if (durationInput && (!durationInput.value || durationInput.value === '0')) {
        	        	  durationInput.value = '8';
        	        	  durationInput.classList.remove('is-error');
        	        	  durationInput.removeAttribute('title');
        	        	  changed++;
        	        	}
        	    	}
        		});
        	    
        	    if (!changed) {
        	        alert('No rows with entry type "Regular Hours" found.');
        	    }
        	 })
        })();
    </script>
{% endblock %}
