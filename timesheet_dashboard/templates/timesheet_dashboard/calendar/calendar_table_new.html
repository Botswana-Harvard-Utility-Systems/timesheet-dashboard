{% extends 'edc_base/base.html' %}
{% load timesheet_dashboard_extras %}
{% load static %}
{% load edc_base_extras edc_admin_modify %}
{% load i18n admin_urls %}

{% block title %}Timesheet Calendar{% endblock %}
{% block extra-css %}
  <style>
    /* Calendar grid styles */
    .calendar-toolbar { gap: .5rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid rgba(0,0,0,.08); border-radius: 5px; overflow: hidden; }
    .calendar-grid .cal-head { background: var(--bs-light); font-weight: 600; text-transform: uppercase; letter-spacing: .02em; font-size: .8rem; padding: .5rem .75rem; border-right: 1px solid rgba(0,0,0,.06); }
    .calendar-grid .cal-head:last-child { border-right: 0; }
    .cal-day { min-height: 8rem; border-right: 1px solid rgba(0,0,0,.06); border-top: 1px solid rgba(0,0,0,.06); background: var(--bs-body-bg); position: relative; }
    .cal-day:nth-child(7n) { border-right: 0; }
    .cal-date {color: var(--bs-secondary); font-size: .8rem; font-weight: 600; padding: .2rem; background-color: var(--bs-light); }
    .cal-body { padding: 1.25rem .75rem .75rem .75rem; display: flex; flex-direction: column; gap: .25rem; }
    .cal-day.is-today { background: rgba(13,110,253,.035); box-shadow: inset 0 0 0 2px rgba(13,110,253,.15); }
    .cal-day.is-outside { background: rgba(0,0,0,.02); color: var(--bs-secondary); }
    .cal-chip { display: inline-flex; align-items: center; padding: .15rem .5rem; border-radius: 999px; font-size: .75rem; background: var(--bs-primary-bg-subtle); }
    .cal-chip .bi { font-size: .9rem; margin-right: .25rem; }
    .calendar-legend .badge { font-size: .7rem; }
    @media (max-width: 768px) { .cal-day { min-height: 6.5rem; } }
  </style>
{% endblock %}

{% block main %}
<div class="row g-3">
  <!-- Main column -->
  <div class="col-12 col-lg-9">
    <!-- Toolbar -->
    <div class="md-card mb-3">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between calendar-toolbar">
        <div class="d-flex align-items-center gap-2">
          <a {% if p_role %}
          		href="{% url timesheet_listboard_url %}?p_role={{ p_role }}"
          	 {% else %}
          	 	href="{% url timesheet_listboard_url employee_id %}"
          	 {% endif %}
          	class="btn btn-outline-info btn-sm">
          		<i class="bi bi-arrow-left"></i> Back to list
          </a>
          <h1 class="h5 mb-0">{{ month_name }} {{ year }}</h1>
        </div>
        <form method="get" class="d-flex flex-wrap align-items-end gap-2">
          <div>
            <label class="form-label small mb-1">Jump to</label>
            <input type="month" name="month" value="{{ year }}-{{ month|floatformat:0|stringformat:'02d' }}" class="form-control form-control-sm" />
          </div>
          <div class="d-flex align-items-end gap-2">
            <button class="btn btn-sm btn-primary" type="submit"><i class="bi bi-calendar-event me-1"></i>Go</button>
            <a class="btn btn-sm btn-outline-primary" href="?month={{ prev_month_param }}" title="Previous month"><i class="bi bi-chevron-left"></i></a>
            <a class="btn btn-sm btn-outline-primary" href="?month={{ next_month_param }}" title="Next month"><i class="bi bi-chevron-right"></i></a>
            <a class="btn btn-sm btn-outline-secondary" href="?month={{ current_month_param }}" title="Today">Today</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Calendar header (Mon - Sun) -->
  
  	<form method="post"
  		id="timesheet_form"
  		action="{% url 'timesheet_dashboard:timesheet_calendar_table_url' employee_id year curr_month %}?p_role={{ p_role }}"
  		name="timesheet">
      {% csrf_token %}
      <div class="calendar-grid">
        {% for title in week_titles %}
        	<div class="cal-head text-center">{{ title }}</div>
        {% endfor %}
        {% for key, values in daily_entries_dict.items %}
         	{% if forloop.first %}
                {% for b in blank_days_range %}
                    <div class="cal-day {% if day.is_today %}is-today{% endif %} {% if day.is_outside %}is-outside{% endif %}">
                    	<input class='blank_cells' type='hidden' value=''/>
                    </div>
                {% endfor %}

            {% endif %}
        	{% for entry in values %}
	       		<div class="cal-day {% if day.is_today %}is-today{% endif %} {% if day.is_outside %}is-outside{% endif %}">
	              <div class="cal-date">{{ entry.day |date:'j'}}</div>
	              <div class="day-form">
	                <div class="mb-1">
	   
	                  <input id="{{ entry.day |date:'j'}}-duration"
	                  		 type="number" class="form-control form-control-sm"
	                  		 name="{{ entry.day |date:'j'}}-duration"
	                  		 value="{{ entry.duration|default:'' }}" min="0" step="0.5"
	                  		 {% if review or verify or read_only %}
	                  		 	readonly
	                  		 {% endif %}>
	               	</div>
	               	<div class="mb-1">
	                  <select 	id="{{ entry.day |date:'j'}}-entry_type"
	                  			class="form-select form-select-sm"
	                  			name="{{ entry.day |date:'j'}}-entry_type"
	                  			{% if review or verify or read_only %}
	                  		 		disabled
	                  		 {% endif %}>
	                  	 {% if is_security %}
                             {% for e in entry_types %}
                                 <option value={{ e.0 }} {% if e.0 == entry.entry_type %} selected {% endif %}>{{ e.0 }}</option>
                             {% endfor %}
                         {% elif review %}
                             <option value={{ entry.entry_type }} selected>{{ entry.entry_type }}</option>
                         {% else %}
	                   		{% if entry.day|is_holiday and is_security %}
                            	<option value='H' selected> H</option>
                            {% elif entry.day|is_holiday and not is_security %}
                            	<option value='WE' selected> WE</option>
                            {% elif entry.day|is_weekend %}
                            	<option value='WE' selected> WE</option>
                            {% else %}
                            	{% for e in entry_types %}
                            		<option value={{ e.0 }} {% if e.0 == entry.entry_type %} selected {% endif %}>{{ e.0 }}</option>
                                {% endfor %}
                            {% endif %}
                         {% endif %}
	                  </select>
	                </div>
                    <input id='{{ entry.day |date:"j"}}-day' type='hidden'
                           value='{{ entry.day|date:"Y-m-d"}}'
                           name='{{ entry.day |date:"j"}}-day'/>
                    <input id='{{ entry.day |date:"j"}}-row' type='hidden'
                           value={{ entry.row }} name='
                           {{ entry.day |date:"j"}}-row'/>
	              </div>
	            </div>
	        {% endfor %}
        {% endfor %}
      </div>
      <div class="mt-2 d-flex justify-content-between">
      	<div class="d-flex gap-2 ms-auto">
      	{% if review %}
            <button type="button" class="btn btn-danger" id="reject-record">
                <i class="bi bi-x-octagon-fill"></i> Reject
            </button>
            <button type="button" class="btn btn-success" id="approve-record">
                <i class="bi bi-hand-thumbs-up-fill"></i> Approve
            </button>
        {% elif verify %}
            <button type="button" class="btn btn-danger" id="reject-record">
                <i class="bi bi-x-octagon-fill"></i> Reject
            </button>
            <button type="button" class="btn btn-success" id="verify-record"
            		 {% if timesheet_status != 'Approved' %}disabled{% endif %}>
                <i class="bi bi-shield-fill-check"></i> Verify
            </button>

        {% else %}
        	<input name="curr_month" id="curr_month" type="hidden"
                   value="{{ curr_month }}"/>
           	<input name="year" id="year" type="hidden"
                   value="{{ year }}"/>
           	<input name="last_day" id="last_day" type="hidden"
                   value={{ last_day }}/>
           	<input name="holidays" id="holidays" type="hidden"
                   value={{ holidays }}/>
           	<input name="no_of_weeks" id="no_of_weeks" type="hidden"
                   value="{{ no_of_weeks }}"/>
           	<input name=prefilled_rows id="prefilled_rows" type="hidden"
                   value="{{ prefilled_rows }}"/>
           	<input name="blank_days" id="blank_days" type="hidden"
                   value="{{ blank_days }}"/>

            
           	{% if not read_only %}
                 <button type="button" class="btn btn-info" id="auto_fill">
                    <i class="bi bi-plus-circle"></i> Auto-fill
                 </button>
                 <button type="submit" class="btn btn-warning" id="save-record">
                     <i class="bi bi-floppy"></i> Save
                 </button>
                 <button type="button" class="btn btn-success" id="save-submit-record" style="display:none;">
                     <i class="bi bi-send-plus"></i> Save and Submit
                 </button>
             {% else %}
             	{% if timesheet_status == 'Rejected' %}
                    <a type="button" class="btn btn-danger" disabled>
                        {{ timesheet_status }}
                    </a>
                {% else %}
                    <a type="button" class="btn btn-success" disabled>
                        {{ timesheet_status }}
                    </a>
                   {% endif %}
              {% endif %}
           {% endif %}
           </div>
      </div>
    </form>
  	<div class="d-flex justify-content-between align-items-center mt-2 calendar-legend">
      	<div class="d-flex gap-2 align-items-center small">
        	<span class="badge text-bg-primary"><i class="bi bi-clock-history me-1"></i>Hours</span>
        	<span class="badge text-bg-warning"><i class="bi bi-lightning-charge me-1"></i>Overtime</span>
        	<span class="badge text-bg-success"><i class="bi bi-sun me-1"></i>Leave</span>
      	</div>
      	<div class="small text-secondary"><b>NOTE:</b> Complete all entries before <em>*Save and Submit*</em>. Use <em>*Save*</em> to keep progress.</div>
    </div>
 </div>
 
 <!-- Begin SidePanel -->
 <div class="col-12 col-lg-3">
    <div class="md-card">
      <div class="card-body">
      	<h5 class="card-title p-3 bg-info bg-opacity-10 border border-info rounded-start rounded-end">Employee {{ employee_id }}</h5>
        <hr>
        {% demographics employee_id %}
        <hr>
        <h6 class="mb-2">Monthly Stats</h6>
        <div class="d-flex flex-column gap-2 small">
  			{% if leave_balance %}
          	<div class="d-flex justify-content-between">
          		<i class="bi bi-calendar2-check text-success"></i>
          		<span>Annual Leave Taken:</span><strong>{{ leave_taken|default:'0' }}</strong>
          	</div>
          	<div class="d-flex justify-content-between">
          		<i class="bi bi-calendar2-plus text-primary"></i>
          		<span>Annual Leave Balance:</span><strong>{{ leave_balance|default:'0' }}</strong>
          	</div>
			{% endif %}
          	<div class="d-flex justify-content-between">
          		<i class="bi bi-hourglass-split text-warning"></i>
          		<span>Monthly Overtime:</span><strong>{{ overtime_worked|default:'0' }}</strong>
          	</div>
        </div>
        <hr>
        <h6 class="mb-2">Timesheet Status</h6>
        <div class="d-flex flex-column gap-2 small">   	
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-info-circle text-info"></i>
       			<span>Status:</span>
       			<span class="badge text-bg-{{ timesheet_status_badge|default:'secondary' }}">
       				{{ timesheet_status|default:'New' }}
       			</span>
       		</div>
       		{% if submitted_datetime %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-calendar2-event text-primary"></i>
       			<span>Submitted:</span>{{ submitted_datetime|date:"SHORT_DATE_FORMAT" }}
       		</div>
       		{% endif %}
       		{% if rejected_by %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-calendar2-x text-danger"></i>
       			<span>Rejected:</span>{{ rejected_by }}
       		</div>
       		{% endif %}
       		{% if approved_by %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-calendar2-check text-success"></i>
       			<span>Approved By:</span>{{ approved_by }}
       		</div>
       		{% endif %}
       		{% if verified_by %}
       		<div class="d-flex justify-content-between">
       			<i class="bi bi-person-check text-success"></i>
       			<span>Verified By:</span>{{ verified_by }}
       		</div>
       		
       		{% endif %}
        </div>
        <hr>
        <h6 class="mb-2">Comments</h6>
        <textarea class="form-control" name="comment" form="timesheet_form" id="comment"
                          rows="4"
                          onkeyup="Allow()" placeholder="write a comment......"
                          style="width:100%; border:0;"
                        {% if not review and not verify %}
                          disabled
                        {% endif %}>
                   	{% if comment %} {{ comment }} {% endif %}</textarea>
      </div>
    </div>
  </div>
</div>
{% endblock %}
